# Description

The description subsystem of the `KnowledgeBase` class provides powerful mechanisms for associating, retrieving, and rendering human-readable descriptions for registered databases (relationships) within a knowledge base. Descriptions can be attached programmatically during registration, stored as README files within the data directory, or parsed from a top-level knowledge base README. Additionally, the system allows rendering Markdown summaries of database structure and content.

## Attaching and Retrieving Database Descriptions

When registering an association or database within a knowledge base, a textual description of its purpose or content can be provided directly as an option. This description is then stored in the registry and may later be retrieved via the `#description(name)` method.

**Example – Registering with a direct description:**
```ruby
TmpFile.with_dir do |dir|
  brothers = datafile_test(:person).brothers
  kb = KnowledgeBase.new dir
  kb.register :brothers, brothers, description: "Sibling relationships."
  assert_equal "Sibling relationships.", kb.description(:brothers)
end
```
This demonstrates immediate retrieval of the attached description.

If a direct description is not provided on registration, the system attempts to load the description from a file. It checks for a file named `<name>.md` (e.g., `brothers.md`) in the data directory:

**Example – Loading from a per-database markdown file:**
```ruby
TmpFile.with_dir do |dir|
  brothers = datafile_test(:person).brothers
  kb = KnowledgeBase.new dir
  kb.register :brothers, brothers
  kb.dir['brothers.md'].write "Sibling relationships."
  assert_equal "Sibling relationships.", kb.description(:brothers)
end
```

If neither an explicit nor a per-database file description exists, the system then parses the general README (`README.md`) for a section matching the name of the registered database (using headers such as `# Brothers`). This parsing follows a pattern where a high-level prose block can introduce the overall knowledge base, with each database described in its own section.

**Example – Extracting a database-specific section from kb README.md:**
```ruby
TmpFile.with_dir do |dir|
  brothers = datafile_test(:person).brothers
  kb = KnowledgeBase.new dir
  kb.register :brothers, brothers
  kb.dir['README.md'].write <<-EOF
Databases describing people and their relationships.

# Brothers

Sibling relationships.
  EOF
  assert_equal "Sibling relationships.", kb.description(:brothers)
end
```

If even this is absent, the system will attempt to resolve up the directory structure for README files located in the source directory of the registered association. This enables both local (per-db) and global (per-KB) documentation strategies.

## Rendering Database Structure as Markdown

The `KnowledgeBase#markdown(name)` method produces a Markdown summary documenting the structure of a given database, including its source and target types, their accepted formats, directionality, and description. It combines both programmatic metadata and textual descriptions.

**Example – Validating structural fields in markdown:**
```ruby
TmpFile.with_dir do |dir|
  brothers = datafile_test(:person).brothers
  kb = KnowledgeBase.new dir
  kb.register :brothers, brothers
  assert_include kb.markdown(:brothers), "Older"
end
```

This test confirms that characteristic metadata or field names (such as "Older") are surfaced in the Markdown documentation generated by the system.

## Hierarchy of Description Resolution

1. **Registry:** Explicit `description` argument provided at registration.
2. **Per-db Markdown file:** `<db>.md` within the KB directory.
3. **Knowledge base README:** Section within `README.md` under `# <Db>` header.
4. **Source dataset README:** `README.md` in the source data file's directory.
5. **Fallback:** If none found, description may be `nil`.

## Utility Methods

- `.parse_knowledge_base_doc` and supporting methods provide the backend for parsing KB-level documentation and splitting it by database section.
- Methods like `database_description_file` and `knowledge_base_description_file` encapsulate the logic for locating the most appropriate description file for a given registered database.

## Design and Edge-case Handling

- Descriptions from the registry override all file-based sources.
- If no description is found, `description(name)` returns `nil`.
- The Markdown rendering robustly falls back to whatever metadata is available.
- Description resolution supports both Symbol and String names transparently.

## Summary

The description functionality offers a layered and flexible documentation mechanism for entities and relationships in a knowledge base. It accommodates workflows ranging from highly-curated manual documentation in Markdown to automated metadata reporting, ensuring that every registered database can be accompanied and rendered with informative, discoverable descriptions. The thorough coverage in the test suite guarantees correct precedence, file fallback logic, and Markdown rendering alignment with real-world expectations.